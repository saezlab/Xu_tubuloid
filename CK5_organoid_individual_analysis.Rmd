---
title: "Single-cell analysis on CK5 late organoid"
author: "Javier Perales-Paton - javier.perales@bioquant.uni-heidelberg.de"
date: "11/28/2019"
license: "GPL-v3"
output: html_document
---

```{r setup, include=FALSE}
Sys.setenv(RSTUDIO_PANDOC="/usr/lib/rstudio/bin/pandoc")
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries and auxiliar functions

```{r libs}
set.seed(1234)
suppressPackageStartupMessages(require(Seurat))
suppressPackageStartupMessages(require(GSEABase))
suppressPackageStartupMessages(require(dplyr))
suppressPackageStartupMessages(require(genesorteR))
suppressPackageStartupMessages(require(ComplexHeatmap))
suppressPackageStartupMessages(require(clustree))
suppressPackageStartupMessages(require(cowplot))
source("./src/seurat_fx.R")
```


## Read data into a Seurat Object
```{r data, cache=TRUE}
SeuratObject <- getSeuratObject(path = "./data/sc/Organoid/filtered_feature_bc_matrix/",
                     project_name = "CK5_organoid", 
                     mt.pattern = "^MT-", min.cells = 5, 
                     min.features = 200)

# Define output directory
OUTDIR <- paste0("./output/",Project(SeuratObject))
if(! dir.exists(OUTDIR)) dir.create(OUTDIR, recursive = TRUE)
```

## Quality control

```{r QC,fig.width=14, fig.height=4}
print(VlnPlot(SeuratObject, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3))

print(CombinePlots(plots = list(FeatureScatter(SeuratObject, feature1 = "nCount_RNA", feature2 = "percent.mt"),
                                FeatureScatter(SeuratObject, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")))
)

```

## Data cleasing: gene and cell filtering
To avoid unnecessary sparsity and noise in downstream analysis,    
* We discard cells with low (<200) and high (>6000) number of genes detected to 
avoid bad quality and doublets, repectively.    
* We discard genes not detected across cells.    
For this we use cutoffs in concordance with kidney tissue, where Proximal tubule
cells might have a high content of mitochondrial genes (<80%). Later we will
apply diagnostics to see if this is related.

```{r cars}
nSamples_before <- ncol(SeuratObject)
SeuratObject <- subset(SeuratObject, nFeature_RNA > 200 & nFeature_RNA < 6000 & percent.mt < 80)
nSamples_after <- ncol(SeuratObject)
```

Doing so, `r nSamples_after` out of an initial `r nSamples_before` total were retrieve
for the analysis, thus discarding a `r (nSamples_before - nSamples_after)` cells.

## Pre-processing the data for cell clustering and cell-type assignment
First, we normalize the data using default parameters
```{r norm, cache=TRUE}
SeuratObject <- NormalizeData(SeuratObject)
```

Second, we perform a feature selection based on `vst` method to select 
high variable genes (top 2000) for cell clustering.
```{r sel, cache=TRUE}
SeuratObject <- FindVariableFeatures(SeuratObject, selection.method = "vst", nfeatures = 2000)

print(LabelPoints(VariableFeaturePlot(SeuratObject),
                  points=VariableFeatures(SeuratObject)[1:10],repel = TRUE))
```

Third, we center and scale the data prior PCA:

```{r scale,cache=TRUE}
SeuratObject <- Seurat_scaledata(SeuratObject)
```

Finally we perform PCA, selecting a number of PCs that are relevant based on the
elbow plot. We tested that our results are not sensitive to this parameter, and
the arbitrary selection of number of PCs do not change final conclusions.
```{r pca, cache=TRUE}
SeuratObject <- RunPCA(SeuratObject, features = VariableFeatures(SeuratObject), npcs = 50)
print(ElbowPlot(SeuratObject,ndims = 50) + geom_vline(xintercept = 25, col="red"))
```

We decided to use 25 PCs for the clustering.

## Cell clustering
We are going to use Shared-Nearest Neighbour with Graph partitioning for cell clustering.
We run the algorithm with multiple resolutions. Later this is read-out to give 
an idea how these are consistent from a lower to high number of expected cell populations
in the sample.   

```{r clust, cache=TRUE}
SeuratObject <- FindNeighbors(SeuratObject, dims = 1:25)
SeuratObject <- FindClusters(SeuratObject, resolution = seq(from=0.1, to=1, by=0.1))

# We redefine the final partitioning with resolution 0.5
SeuratObject <- FindClusters(SeuratObject, resolution = 0.5)
```

We will investigate how the selection of multiple resolutions affects the partition
into individual cell clusters.
```{r clustree, fig.width=7, fig.height=10}
clustree(SeuratObject, prefix = "RNA_snn_res.")
```

## Cell marker extraction
We are going to use two methods for the extraction of cell markers.   
1. Differential gene expression using wilcox test from Seurat. Only positive
and consistent markers will be tested (with default parameters).   
2. GenesorteR to get posterior probabilities for each gene of observing a certain
cell population.

### 1 wilcox test
```{r wilcox, cache=TRUE}
up <- setNames(vector("list",length=length(levels(SeuratObject))), 
               levels(SeuratObject))
for(idx in names(up)) {
  up.idx <- FindMarkers(SeuratObject,ident.1 = idx, 
                        ident.2 = setdiff(levels(SeuratObject), idx), only.pos=T)
  cols_names <- colnames(up.idx)
  
  # Add two extra cols
  up.idx$cluster <- idx
  up.idx$gene <- rownames(up.idx)
  
  up[[idx]] <- up.idx
}
```

### 2 Gene sorter

```{r genesort, cache=TRUE}
### 2 genesorteR
sg <- sortGenes(SeuratObject@assays$RNA@data, Idents(SeuratObject))

#define a small set of markers
mm = getMarkers(sg, quant = 0.975)

#cluster genes and make a heatmap
pp = plotMarkerHeat(sg$inputMat, sg$inputClass, mm$markers, clusterGenes=TRUE, outs = TRUE)

pp$gene_class_info #gene clusters

#the top 25 genes for each cluster by specificity scores
top_markers = apply(sg$specScore, 2, function(x) names(head(sort(x, decreasing = TRUE), n = 25)))

```

Finally we save the markers for manual exploration:

```{r init_markers_save}
MARKERS_OUTDIR <- paste0(OUTDIR,"/Markers/Init")
if(! dir.exists(MARKERS_OUTDIR)) dir.create(MARKERS_OUTDIR, recursive = TRUE)

# Wilcox
for(idx in names(up)) {
  write.table(up[[idx]][,c("cluster", "gene", cols_names)],
              file = paste0(MARKERS_OUTDIR,"/cluster",idx,".tsv"),
              sep="\t",col.names = TRUE, row.names = FALSE, quote=FALSE
  )
}

# Genesorter
write.table(as.matrix(sg$specScore), paste0(MARKERS_OUTDIR,"/specScore.tsv"),
            sep="\t",row.names = TRUE,col.names = NA,quote=FALSE)

write.table(as.matrix(sg$condGeneProb), paste0(MARKERS_OUTDIR,"/condGeneProb.tsv"),
            sep="\t",row.names = TRUE,col.names = NA,quote=FALSE)
```

## Non-linear dim reduction (umap)

```{r umap, cache=TRUE}
SeuratObject <- RunUMAP(SeuratObject, dims = 1:25)
```

```{r umap_plot, fig.width=4, fig.height=4}
DimPlot(SeuratObject, reduction = "umap", label = TRUE, label.size = 8)
```

## Cell assignment
We took a look at the markers from the different clusters from previous section.
These can be found in the `output` directory.


We took a look at the markes from previous section, making the following summary
| Cluster | rational |
|:---:|:---:|
| Cluster 0 | SLC34a2 high, SERPINE2+, EMP3+ proximal tubule  AKAP12 29% PT like |
| Cluster 1 | 35% SLC12a3, SLC14a2 5%, Distal Convoluted Tubule (DCT) AKAP12 25% |
| Cluster 2 | 3% SLC12a1, SLC34a2 high, NCOA7+, LTF+ AKAP12 15% PT like |
| Cluster 3 | 25% SLC12a3 Distal Convoluted Tubule,Col4a3+, Col4a4+, SCN2a+ AGR3+, DEFB1+,  SLC14a2 3%, Distal Convoluted Tubule (DCT) no AKAP12 |
| Cluster 4 | NEAT1+, XIST+, MALAT1+, AKAP12 16% delete mito genes, looks odd |
| Cluster 5 | MKI67+, , CENPF, CDKN3, BIRC5, CDC20, NUSAP1, AKAP12 30% proliferating PT-like |
| Cluster 6 | AKAP12 68%, CDH6+, WNT7a+, CLDN7+, AKAP12 68% STCs |
| Cluster 7 | 37% AQP1+, VCAM1 59%, AKAP12 60%, THBS2+, NUPR1+;  AKAP12 60% PEC like |
| Cluster 8 | CD133 0%, VCAM1 33%, THY1+, KRT23, SLIT3, CD13, UPK3B, AKAP12 28%, EPCAM +PEC like |
| Cluster 9 | no Pax8, CD133 13%, no high spec score, ALDH1A3, AKAP12 11% (exclude high ribosomal probably garbadge) |

```{r rename_idents}
ren_id <- c("0"="PT-like",
            "1"="DCT",
            "2"="PT-like",
            "3"="DCT",
            "4"="Exclude_highmito",
            "5"="Proliferating_PT-like",
            "6"="STCs",
            "7"="PEC-like",
            "8"="PEC-like",
            "9"="Exclude_highribosomal")
```


```{r cell_ann}
SeuratObject <- RenameIdents(SeuratObject, ren_id)
```

We cross-check that everything was assigned as it is stated using a set of 
context-specific markers
```{r assign_check, fig.width=10, fig.height=12}
context_genes <- getGmt("./data/Prior/Kramann_early_organoid.gmt")
print(DotPlot(SeuratObject, features = unlist(geneIds(context_genes)), dot.scale = 14) + 
        coord_flip() + scale_y_discrete(position = "right") +
        theme(axis.text.x = element_text(angle = 45, hjust = 0))
)
```

We remove two cell populations that present with over-expression of genes related to bad quality cells.
We observed that cluster 5 over-express high mitochondrial genes, whereas cluster 9 over-express ribosomal genes.
We also rename the remaining cell clusters.

```{r assign_filter}
# Remove original reference to clustering
SeuratObject <- SeuratObject[, !grepl("^(Exclude)", 
                                      Idents(SeuratObject))]

SeuratObject <- RenameIdents(SeuratObject, 
                             setNames(gsub("_[0-9]+","",Idents(SeuratObject)),
                                      Idents(SeuratObject)))

```

```{r assign_dot, fig.width=7, fig.height=12}
print(DotPlot(SeuratObject, features = unlist(geneIds(context_genes)), dot.scale = 14) + 
        coord_flip() + scale_y_discrete(position = "right") +
        theme(axis.text.x = element_text(angle = 45, hjust = 0))
)
```

```{r assign_dot_universal, fig.width=7, fig.height=12}
context_genes <- getGmt("./data/Prior/Kramann_context.gmt")
print(DotPlot(SeuratObject, features = unlist(geneIds(context_genes)), dot.scale = 14) + 
        coord_flip() + scale_y_discrete(position = "right") +
        theme(axis.text.x = element_text(angle = 45, hjust = 0))
)
```

## Re-clustering and high dim. reduction after filtering contaminant populations

To trace back previous cell boundaries, we store the outcome
```{r init_cl}
SeuratObject$init_seurat_clusters <- SeuratObject$seurat_clusters
SeuratObject$init_assign <- Idents(SeuratObject)

```

We proceed with the standard pipeline for cell clustering, over-written previous
outcome

```{r re_clust, cache=TRUE, fig.width=11, fig.height=4}
## Feature selection
SeuratObject <- FindVariableFeatures(SeuratObject, selection.method = "vst", nfeatures = 2000)

## PCA 
SeuratObject <- RunPCA(SeuratObject, features = VariableFeatures(SeuratObject), npcs = 50)
print(ElbowPlot(SeuratObject,ndims = 50) + geom_vline(xintercept = 25, col="red"))

## Cell clustering
SeuratObject <- FindNeighbors(SeuratObject, dims = 1:25)
SeuratObject <- FindClusters(SeuratObject, resolution = 0.5)

## Agreement with previous clustering
table("initial"=SeuratObject$init_seurat_clusters,
      "final"=SeuratObject$seurat_clusters)

table("Assigned"=SeuratObject$init_assign,
      "final"=SeuratObject$seurat_clusters)


## UMAP
SeuratObject <- RunUMAP(SeuratObject, dims = 1:25)
d1 <- DimPlot(SeuratObject, group.by = "init_assign") + ggtitle("Initial Cell assignment")
d2 <- DimPlot(SeuratObject) + ggtitle("Re-classification")

print(CombinePlots(list(d1,d2)))

```

```{r cell_phase}
s.genes <- cc.genes$s.genes
g2m.genes <- cc.genes$g2m.genes

SeuratObject <- CellCycleScoring(SeuratObject, s.features = s.genes, g2m.features = g2m.genes, set.ident = FALSE)
d3 <- DimPlot(SeuratObject, group.by = "Phase") + ggtitle("Cell Cycle Phase")
d4 <- DimPlot(SeuratObject) + ggtitle("Re-classification")

print(CombinePlots(list(d3,d4)))

```

## Getting markers for the final clusters

### 1 wilcox test
```{r final_wilcox, cache=TRUE}
up <- setNames(vector("list",length=length(levels(SeuratObject))), 
               levels(SeuratObject))
for(idx in names(up)) {
  up.idx <- FindMarkers(SeuratObject,ident.1 = idx, 
                        ident.2 = setdiff(levels(SeuratObject), idx), only.pos=T)
  cols_names <- colnames(up.idx)
  
  # Add two extra cols
  up.idx$cluster <- idx
  up.idx$gene <- rownames(up.idx)
  
  up[[idx]] <- up.idx
}
```

### 2 Gene sorter

```{r finalgenesort, cache=TRUE}
### 2 genesorteR
sg <- sortGenes(SeuratObject@assays$RNA@data, Idents(SeuratObject))

```

Save them in tables so we could make a second round of manual exploration on them
for the final assignment.

```{r final_markers_save}
MARKERS_OUTDIR <- paste0(OUTDIR,"/Markers/Final")
if(! dir.exists(MARKERS_OUTDIR)) dir.create(MARKERS_OUTDIR, recursive = TRUE)

# Wilcox
for(idx in names(up)) {
  write.table(up[[idx]][,c("cluster", "gene", cols_names)],
              file = paste0(MARKERS_OUTDIR,"/cluster",idx,".tsv"),
              sep="\t",col.names = TRUE, row.names = FALSE, quote=FALSE
  )
}

# Genesorter
write.table(as.matrix(sg$specScore), paste0(MARKERS_OUTDIR,"/specScore.tsv"),
            sep="\t",row.names = TRUE,col.names = NA,quote=FALSE)

write.table(as.matrix(sg$condGeneProb), paste0(MARKERS_OUTDIR,"/condGeneProb.tsv"),
            sep="\t",row.names = TRUE,col.names = NA,quote=FALSE)
```


## Final cell assignment
The final table of markers on the second round of cell clustering give the following results:

| Cluster | rational |
|:---|:---|
| Cluster 0 | PT-like/STC |
| Cluster 1 | PT-like/STC   |
| Cluster 2 | DCT (GATA3, SLC12A3, KRT19) |
| Cluster 3 | DCT (SPP1, SLC12A3) |
| Cluster 4 | PT-like/STC  |
| Cluster 5 | Prolif_PT-like/STC |
| Cluster 6 | PEC-like  |
| Cluster 7 | PEC-like  |



```{r cell_assign2}
ren_id <- c("0"="PT-like/STC_1",
            "1"="PT-like/STC_2",
            "2"="DCT_1",
            "3"="DCT_2",
            "4"="PT-like/STC_3",
            "5"="Prolif_PT-like/STC",
            "6"="PEC-like_1",
            "7"="PEC-like_2")
SeuratObject <- RenameIdents(SeuratObject, ren_id)

```

## Figures for publishing

> We take in advantage the Knit capability of generating PDF/PNG files in output
folders to save those figures that are going to be included as main or supplementary
figures in the final manuscript.

```{r, mkdir_figs}
FIGS_OUTDIR <- paste0(OUTDIR,"/figs")
if(! dir.exists(FIGS_OUTDIR)) dir.create(FIGS_OUTDIR, recursive = TRUE)
```

```{r CK5_organoid_umap_final, fig.path='./output/CK5_organoid/figs/', dev = c('png','pdf')}
DimPlot(SeuratObject, reduction="umap")
SeuratObject$cell_pop <- gsub("_[0-9]+$","",Idents(SeuratObject))
DimPlot(SeuratObject, reduction="umap", group.by = "cell_pop")
```

```{r CK5_organoid_context_dotplot_final, fig.width=7, fig.height=12, fig.path='./output/CK5_organoid/figs/', dev = c('png','pdf')} 
context_genes <- getGmt("./data/Prior/Kramann_context.gmt")
print(DotPlot(SeuratObject, features = unlist(geneIds(context_genes)), dot.scale = 14) + 
        coord_flip() + scale_y_discrete(position = "right") +
        theme(axis.text.x = element_text(angle = 45, hjust = 0))
)
```

```{r CK5_organoid_wilcox_heatmap_final, fig.width=9, fig.height=8, fig.path='./output/CK5_organoid/figs/', dev = c('png','pdf')}
wilcox_GS <- GeneSetCollection(sapply(names(up), function(z) GeneSet(up[[z]][1:10, "gene"],setName=ren_id[z]), simplify = FALSE))

DoHeatmap2(SeuratObject, GSC = wilcox_GS, assay = "RNA", res = 0.5, show_hr = FALSE)
```

```{r CK5_organoid_specScore_heatmap_final, fig.width=9, fig.height=8, fig.path='./output/CK5_organoid/figs/', dev = c('png','pdf')}
specScore_GS <- GeneSetCollection(sapply(colnames(sg$specScore),function(idx) {
                              GeneSet(names(head(sort(sg$specScore[,idx], decreasing = TRUE), n = 10)),
                                      setName=ren_id[idx], shortDescription="genesorteR")
  }))

DoHeatmap2(SeuratObject, GSC = specScore_GS, assay = "RNA", res = 0.5, show_hr = FALSE)
```

## Session info                                                                                                                                                                                             
                                                                                                                                                                                                            
```{r}                                                                                                                                                                                                      
sessionInfo()
{
sink(file=paste0(OUTDIR,"/sessionInfo.txt"))                                                                                                                                                                
print(sessionInfo())                                                                                                                                                                                               
sink()
}
```
